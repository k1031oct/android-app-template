# This workflow manually generates GitHub Issues from the DEVELOPMENT_PLAN.md file.

name: "Generate Issues from Plan"

on:
  workflow_dispatch:
    inputs:
      phase_number:
        description: 'Phase number to generate issues for (e.g., 1)'
        required: true
        type: string

jobs:
  generate-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write # This permission is required to create issues.
      contents: read # This permission is required to read repository content.

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v3

      - name: "Parse and Create Issues"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PHASE_INPUT: ${{ github.event.inputs.phase_number }}
        run: |
          echo "üöÄ Starting issue generation for Phase $PHASE_INPUT..."

          # --- Step 1: Ensure all necessary labels exist --- 
          echo "üé® Ensuring labels exist..."
          gh label create "Phase $PHASE_INPUT" --color "0E8A16" --description "Tasks related to Phase $PHASE_INPUT" || echo "Label 'Phase $PHASE_INPUT' already exists."
          gh label create "enhancement" --color "a2eeef" --description "New feature or request" || echo "Label 'enhancement' already exists."
          gh label create "frontend" --color "c5def5" --description "Tasks related to UI/UX" || echo "Label 'frontend' already exists."
          echo "‚úÖ Labels are ready."

          # --- Step 2: Extract the content for the specified phase ---
          PHASE_SECTION=$(awk -v phase="$PHASE_INPUT" '$0 ~ "^### „Éï„Çß„Éº„Ç∫" phase ":" {flag=1; next} /^### „Éï„Çß„Éº„Ç∫/ {flag=0} flag' DEVELOPMENT_PLAN.md)

          if [ -z "$PHASE_SECTION" ]; then
            echo "‚ùå Error: Could not find Phase $PHASE_INPUT in DEVELOPMENT_PLAN.md"
            exit 1
          fi

          # --- Step 3: Extract tasks from the section and create issues ---
          echo "$PHASE_SECTION" | while IFS= read -r line; do
            if [[ $line == *"- [ ] "* ]]; then
              # Extract the title from the markdown task line
              title=$(echo "$line" | sed -e 's/- \[ \] \*\*Task:\*\* //' -e 's/\r//')

              # Determine the label list based on task content
              label_list="Phase $PHASE_INPUT,enhancement"
              if [[ $title == *"(frontend)"* ]]; then
                label_list="$label_list,frontend"
                # Clean up title
                title=$(echo "$title" | sed 's/(frontend) //')
              fi

              echo "ü§ñ Creating issue: '$title'"

              # Create the issue using GitHub CLI
              gh issue create --title "$title" --body "This issue was automatically generated from the development plan for Phase $PHASE_INPUT." --label "$label_list"

              if [ $? -eq 0 ]; then
                echo "‚úÖ Successfully created issue."
              else
                echo "‚ùå Failed to create issue. Please check token permissions."
              fi
            fi
          done

          echo "üéâ Issue generation finished!"
